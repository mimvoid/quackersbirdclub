{{/*
  A modified version of the img shortcode provided by Hugo.

  It adds the image's width and height to the HTML when available, which helps to
  prevent layout shifts when the image loads in.

  NOTE: The whitespace around the HTML tags are very particular. Make sure everything
  builds correctly when making any changes!
*/ -}}

{{ $src := .Get "src" }}
{{ $caption := .Get "caption" }}
{{ $altAsTitle := partial "utils/parse_bool" (.Get "altAsTitle") }}

{{ $pageAsset := .Page.Resources.Get $src }}
{{ $asset := $pageAsset | default (resources.Get $src) }}

{{ $width := default $asset.Width (.Get "width" | replaceRE "[^0-9]" "") }}
{{ $height := default $asset.Height (.Get "height" | replaceRE "[^0-9]" "") -}}

{{- if $caption -}}
{{/* Wrap the image in a figure if there is a caption */}}
<figure
  {{ with .Get "class" }}class="{{ . }}"{{ end -}}
  {{ with .Get "style" }}style="{{ safeCSS . }}"{{ end }}
>
{{ end }}
<img
  src="{{ cond (and $asset (not $pageAsset)) $asset.RelPermalink $src }}"
  loading="{{ .Get "loading" | default "lazy" }}"
  {{ with $width }}width="{{ . }}"{{ end }}
  {{ with $height }}height="{{ . }}"{{ end }}
  {{ with .Get "alt" | safeHTMLAttr -}}
    alt="{{ . }}" {{ if $altAsTitle }}title="{{ . }}"{{ end }}
  {{- end -}}
  {{ if not $caption -}}
    {{ with .Get "class" }}class="{{ . }}"{{ end }}
    {{ with .Get "style" }}style="{{ safeCSS . }}"{{ end }}
  {{- end -}}
/>
{{ with $caption }}
  <figcaption>{{ markdownify . }}</figcaption>
</figure>
{{ end }}
